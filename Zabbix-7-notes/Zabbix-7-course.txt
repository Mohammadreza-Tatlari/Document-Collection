https://sbcode.net/zabbix/install-provision-linux/

essential parts about zabbix-7 topic is about to be written followed by sbcode.net documentation.

### ### ###

### 2 - Download and Install The Zabbix Repository ###

following the manual of zabbix installation to install zabbix server
https://www.zabbix.com/download
note:
for package installation arm64 is mostly used on OS running on RasberryPi for instance.



### 3 - Create the Initial Database ###
we can use ` service (mysql/postgrsql) status ` or `systemctl status (mysql)` to check whether we have this programs installed on OS other wise we can install it from `mysql-server`

Setting the log_bin_trust_function_creators variable to 1 relaxes these restrictions:
It allows users to create functions even without the SUPER privilege.
It allows the creation of functions that are not DETERMINISTIC.
its disadvantage:
security issues  and replication issues. thats why after zabbix datastore creation it should be disabled again.

note:
use -v (verbose) in import initial schema and data to be sure that datastore is being created and monitor it.

for verification u can use:
• mysql > show databases; => to see database that is created for zabbix;

• mysql > use zabbix; => to switch to the zabbix datastore.
• mysql > show tables; => to see all tables

• mysql > select * from users; => to see all users

use ` systemctl status zabbix-server ` to check status of zabbix server and remember to enable it if it is not



### 4 - Log in and Configure Zabbix Server Front End ###

in zabbix-frontend wizard be careful, the first user & password that you are providing is the password that is related to user working in your database.

the default zabbix web server password is:
user: Admin
password: zabbix
note:
you can change password in zabbix dashboard Users > Users 



### 5 - Configure a Domain name for the Zabbix Server  ###
you can assign a domain name for your zabbix server (it can be your local DC NS :) )

you need to add a A record to your DNS provider and that A record should Point at your zabbix-server.



### 6 - Configure SSL for Zabbix Server Front end ###
you can use https://certbot.eff.org/ to configure local TLS and SSL connection over HTTP.

remember to select the current Web-server and operating server in which for ubuntu it is called "Linux (snapd)".

* note: for TLS you do need a Domain Name First.

for installation:
• sudo snap install --classic certbot



### 7 - Configure Firewall ###
for configuring firewall be sure that:
SSH 22/TCP is open for remote connection.
HTTP TCP/80 is open for HTTP and CertBot for revalidation of IP (optional)
HTTPS TCP/443 for secure HTTP connection.

Also it is best practice to create a Secure Tunnel connection to your zabbix server thus the only IP that can connect to your monitoring is only you.
you can also assign a range of IPs to the firewall.



### 8 - Overview So Far ###
always remember to make a Diagram about what you have done with details about each component of the project.
for instance:
the connection in webserver which consist of:
- zabbix-frontend on Port 433 , 80 TCP
- zabbix Server on Port 10051
- MySQL on Port 3306 which frontend and webserver are connected to.
- local zabbix agent on Port 10050 which is connected to zabbix-server via 127.0.0.1 (zabbix agent on web-server is used to give information about zabbix-server itself).

note:
zabbix server and zabbix agent version should match otherwise it can make problems.



### 9 - Install Zabbix Agent on Same Network as Zabbix Server ###
follow the zabbix agent installation on: 
https://www.zabbix.com/download?zabbix=7.2&os_distribution=ubuntu&os_version=24.04&components=agent_2&db=&ws=

in /etc/zabbix/zabbix_agentd.conf, this parameters needs modification:
1. Server
2. ServerActive: if the 
3. Hostname : is the name that zabbix-server/zabbix-proxy is going to use to name the host.

- passive check on agent: it means that Zabbix-Server/proxy will send request to agent to retrieve data from it.
- active check on agent: it means that agent will send data automatically to zabbix server/proxy base on an interval timer.
thus:
if zabbix agent is on active check, the "ServerActive" parameter should be modified
if zabbix agent is on passive check, the "Server" parameter should be modified.

Adding a new host:
important parameters that are required for adding a Host:
- Host Name: it should match with the end-Host that data is being recieved.
- Templates: the OS and the Service that the Zabbix is retrieve data from it.
- Host Group: the Host should belong to a host Group for better organization and Consistency.
- Interface and Port: if it is a passive check by server (which it means that server sends request to agent) Ip address of the end host with and Protocol should be set.
- Monitored by:  If server or Proxy is retrieving data.

security purpose:
we can only allow zabbix-server to be able to have connection with port 10050 so it will be more secure. however this rules should be added at the end of project.



### 10 - Install Zabbix Agent Active on a Windows Host Behind a Firewall ###
CGNAT (Carrier-Grade Network Address Translation)
CGNAT is a network address translation (NAT) method used by internet service providers (ISPs) to share public IP addresses among multiple customers. thus it can not be a static IP so for that we can use an Active Agent to send data to the Static Based IP Of Zabbix-Server. also CGNAT will prevent hosts from port forwarding.

installation of Zabbix Agent Windows Wizard:
in Wizard,
- zabbix server IP/DNS : is the zabbix server in which the agent will connect to
- Server or Proxy active checks: for Active Proxy.

configuration caution:
- be sure that the ports are open for both sides and are not blocked by firewall.
so actually zabbix agent connect to server via port 10051
- if agent is active and it pushes data to server/proxy, in the server the interface is not required. (should be double checked!)
so simply if agent is on Active mode, it means that the port 10051 of zabbix-server or 10052 of zabbix-proxy should be open to it. and port 10050 is not required cause it is one way sending data. but if pasive is active so the 10050 should also be added cause in this case server will send request to 10050 of agent on end-host.
note:
the passive or active of agent will be demonstrate on host > items > Type.



### 11 - Install Zabbix Agent on CentOS on a different Cloud Provider ###



### 13 - Enable PSK (Pre-Shared Key) Encryption for Zabbix Agents ###
PSK is usually used for traffic that is passing through the public internet.
however, if your policy is that the local connections should also use PSK it is okay.

configuration:
- On end-host (linux):
	• openssl rand -hex 32: creates a 256 bit PSK secret on end-host
	• mkdir /home/zabbix/secrets/ => creating a directory to hold secrets
	• openssl rand -hex > secret.psk => creating a psk secret filewith openssl
	• chown zabbix:zabbix secret.psk => only zabbix user can read/write the file
	• chmod 640 secret.psk => changing premission to not let anymone to read it.
      -• /etc/zabbix/zabbix_agent > TLSConnect=psk => enable psk TLS connection on agent.
	• /etc/zabbix/zabbix_agent > TLSAccept=psk => agent will reject if data is not encrypted in PSK.
	• /etc/zabbix/zabbix_agent > TLSPSKFile=/home/zabbix/secrets/secret.psk=> location where the psk is created
	• /etc/zabbix/zabbix_agent > TLSPSKIdentity=Win-Terminal-Srv1 =>telling zabbix server/proxy which key name to use
	
- on zabbix-server
	• in Host > Encryption => add PSK and PSK check, add PSK Identity equal to end-host and create random openssl -hex 32 for PSK field.



### 14 - Creating Host Items ###
you can create a customized Item from Hosts and receive them only.
it can improve speed and bandwidth of the network by reducing more request packets.
also using template can cause so much overload over server so it is recommended to use Items creation.

Data Collection > Hosts > Items > Create Item(top button).
parameters:
• Type: the data that is coming from which protocol.
• Key: the parameters that needs to be monitored
• Type of Information:
	- Numeric (unsigned): it can be from 0 to infinite
	- Numeric (float): it can contain Negative Number
	- Character: data that contains text and char in it
	- Log: information that has format, like date 
	- text: log texts
	- 
• update Interval: the time that it will be requested or pushed.
• Timeout: it will consider the host to be unavailable.
• History: time of storing the data on database.
• value mapping: the customized value that will be shown in monitoring for parameters.
• Unit: it received values like "B" for byte or "%" for percentage , etc to show the information in that format 

Zabbix Agent Ping	Zabbix Agent (active)	agent.ping	
Free Space	Zabbix Agent (active)	vfs.fs.size[C:,free]	B
CPU (User)	Zabbix Agent (active)	system.cpu.util	%

creating an item
https://www.zabbix.com/documentation/current/en/manual/config/items/item

zabbix agent
https://www.zabbix.com/documentation/current/manual/config/items/itemtypes/zabbix_agent

Unit Symbols
https://www.zabbix.com/documentation/current/manual/appendix/suffixes

note:
in Items, "Execute Now" Option is only available for Passive Items because it is the server that is requesting for value.



### 15 - Creating Host Triggers ###
triggers are used for re-evaluating a host when the parameter that is received from it is pased from specific expectation. for example the value is higher than the maximum threshold.

Data Collection > Hosts > Triggers > Create Trigger

Examples of time-based functions are nodata(), date(), dayofmonth(), dayofweek(), time(), now()

for example:
NODATA 60 seconds	Disaster		nodata(/host/agent.ping,60)=1
Less than 5GB free	High			last(/host/vfs.fs.size[/,free])<5000000000
High CPU Usage 75% for 2 minutes	Warning	avg(/host/system.cpu.util[,user],2m)>75

useful documents for creating trigger:
https://www.zabbix.com/documentation/current/en/manual/config/triggers

trigger functions:
https://www.zabbix.com/documentation/current/en/manual/appendix/functions



### 16 - Set up the Email Media Type ###
we can add email to zabbix for notifying admins. the mail server can be used for disaster alerts for instance.

• Alert > Media types > mail
however there are so many other ways that can be used to send notification
also template for email can be modified.

note: for email on SMTP protocol we need a mail server which most organization do provide.

you should also enable Alerting from Actions Section
Alerts > Actions > Trigger Action > enabling "Report problems to Zabbix administrators"

the Media Should be also enabled for each user after the Alert is added.
Users > Users > (select a User) > Media > Add.



### 17 - Creating Host Graphs ###
you can see each component graph for each host by going to:
data collection > hosts > click on Items > then click on 3 horizontal dots > and select Graph from the drop down menu.
you can also go to:
Monitoring > Latest data > (filter the Host) optional > and select the graph at the end of host name space.

side note:
for creating Items from each host to Monitor we can use cloning options which can be seen when we are in New Item Component Windows.

for creating a Graph:
Data collection > Hosts > Click on Graph > create a new Graph 

note:
you can also add Triggers to be shown on Graphs



### 18 - Convert Host Items Triggers and Graphs To A Template ###
we create template for triggers hosts and their items to make it easy to add new hosts base on similar parameters and goals.
tamplates are in:
Data Collection > Template 

we can also add hosts setup or items and graphs to a template by using "Copy" option in their tabs and copy them in to desired template.

remember that when a host is created and is up based by a template, the items or graphs cannot be edited unless the modification are done on template directly.



### 19 - Template Dashboards ###
you can create a template for dashboards and it is located in:
Data Collection > Templates > Dashboard Button

when a template for dashboard is created the data which is being demonstrate on each graph or visualization will be contain of place holders become that visualization is going to be used for hosts.

note:
some data like gauges or clock should not be persisted on database for more than 7 days because they can affect performance and long run issues.



### 20 - Global Dashboards ###
in the global dashboard we have three main components:
Global View: which is the main zabbix dashboard and its difference is that it can show data from multiple hosts.
Zabbix Server: which is consist of a diagram of Hosts and Nodes.
zabbix server health: which contain graph and visualization about zabbix server condition.



### 21 - Creating a Network Map ###
it is possible to create a Diagram/map of a network inside the zabbix and assign triggers to them to have a better visualization of network.
Monitoring > Maps > Create a New Map.

in map we can use macros to make Labels and Each node property as dynamic name for example using {Host.Name} for label of the zabbix node:
https://www.zabbix.com/documentation/current/en/manual/appendix/macros/supported_by_location



### 22 - Reading Windows Event Logs ###
in windows OS logs are preserved in Event Viewer > Windows Logs and each section has its own logs.

these logs are holding are activities that are happening on the windows. so we can use them to monitor it on our zabbix server.
note:
be sure that the logs are logged on by Local system and not other accounts, to check it go to:
Services > ( service Name) > properties > Log On. and it should be on Local System account to be send by Agent to Zabbix Server/Proxy

to create an Item for Event logs it is recommended to add that Item to a Template:
Data Collection > Templates > Items > create Item.
example of a Failed Login Item:
	Important Properties:
		it needs to be an Active check to receive logs from Events
		Key value can be: eventlog(Security,,,<eventid>,,<mode>)
			- security indicated the section which it belongs
			- eventid relates to ID number which it is in SystemLog
			- the action that happens for logs (ie: skip; which only checks when there is new event logs)
			- Type of inofmation is Log
		https://www.zabbix.com/documentation/current/en/manual/config/items/itemtypes/zabbix_agent/win_keys



### 23 - Item Preprocessing with Regex ###
https://www.zabbix.com/documentation/current/en/manual/config/items/preprocessing

pre-processing means to add something to the data before monitoring it.
for instance when we receive log data from a host it might include some useless information inside that too. so we need a way to filter it out in order to not fill our database with useless information.

for instance we can use regex to filter out the data that is being collected from log files.
for that we can use:
https://regex101.com/

for instance we do regex on Failed Login logs:
Account Name:\t\t(.*)  \1=> it will filter out the whole text and only shows the lines which have "Account Name" in it and if there is 2 output similar it will show the second one.

to imply the preprocessing step, we should go do:
Templates > Items > (Open or create an Item) > preprocessing tab.
and add the regex parameters in to parameters tab and also add the output (\1 or \0) to it.



### 24 - Item Preprocessing with JavaScript ###
it is also possible to do preprocessing with JS similar to regex but keep in mind that in zabbix v7 the javascript version that is supported is ES5 so variables like const and let are not allowed.

for instance:
var lines = value.split('\n')
var lineZero = lines[0]
var accountName = ''
lines.forEach(function (line) {
  if (line.trim().substring(0, 13) === 'Account Name:') {
    accountName = line.substring(14).trim()
  }
})
return accountName + ' : ' + lineZero

https://www.zabbix.com/documentation/current/en/manual/config/items/preprocessing/javascript



### 25 - Remote HTTP monitoring using Web Scenarios ###
we can monitor a website if that website is in range of our host or it also can be out of zabbix domain. but remember that this web check actually happens by zabbix server or proxy itself and not by agent so it means that request to fetch data will be sent from the zabbix server to that website. however it is also possible to send the data as a pretender.

to do so:
template > (desired host) > web > create new scenario.
scenario and steps 

it is possible to add query parameters and status checks for query parameters.

to check out web, in latest data filter out "scenario". 


9-Web Monitoring
https://www.zabbix.com/documentation/current/en/manual/web_monitoring
Real-life scenario
https://www.zabbix.com/documentation/current/en/manual/web_monitoring/example



### 26 - JSON API Monitoring with the HTTP Agent Item ###
we can do JSON API operation by Zabbix. for instance GET data from a website API and monitor it on zabbix server. it is also possible to do POST or PUT request on API too.
it also doesn't matter which host is request the API because it is the Server/Proxy which is request that API call.

to add API based Item:
Template > Items > create Item > Type: HTTP Agent. (items can be filled based on request and json format).

also it is possible to do preprocessing on JSON values for that we can used:
https://jsonpath.com/
JSON Path Examples:
https://www.zabbix.com/documentation/current/en/manual/config/items/preprocessing/jsonpath_functionality

to test preprocessing value first we need to check "Get Value from host" and then add the fetch data after JSONPath implimentation.

note:
when we do pre-processing we also can changed the format of items to desired way cause we have already filtered out the outcome.

it is also possible to used direct URL instead of filtering out with JSONPath.

if HTTP request has authentication it should be consider to add that in Item's value which is "HTTP authentication" and based on security it can be vary.



### 27 - Log File Monitoring ApacheNginx HTTP Status Codes ###
Monitoring Log files - HTTP status COdes of an Apache or Nginx web server.
* we can adapt this feature to monitor production webserver.

there are some steps to be able to read logs from web-servers on devices.
firstly we are trying the access log on zabbix-server itself.

to monitor logs from these services (ie: nginx):
1. we should first located the log files that are on Linux, which are usually in:
/var/log/(nginx/apache2)/

2. we need access.log file but we need to be sure whether zabbix have access to it or not.
to do so:
• ls -lh => to see which groups have access to the files.
• groups zabbix/zabbix agent => to check which group zabbix is belonged to.
• usermod -a -G (adm) zabbix => adding zabbix to the group that has access to log files.
• sudo -H -u zabbix bash -c 'tail -f /var/log/nginx/access.log' => we commit a tail command as zabbix user to be sure that zabbix has access to log file.

3. then we need to use regex expression in order to filter out the data that is being received for the nginx log file.
we can use regex101 website 
example of a regex being used:
^(\S+) (\S+) (\S+) \[([\w:\/]+\s[+\-]\d{4})\] \"(\S+)\s?(\S+)?\s?(\S+)?\" (\d{3}|-) (\d+|-)\s?\"?([^\"]*)\"?\s?\"?([^\"]*)\" => this regex file also have escape quotations in order to be used in HTTP agent Items in zabbix. ( " " ) remember to use double quote.
note:
in regex we have defined groups so in we can use \8 for <output> to should 8th group. so it means only status codes.

4. then we need to add a new Item in zabbix template with the Type: Zabbix agent (active). the key need to be " log[]:  Log file monitoring "

5. add trigger base on status error of 404 in order to check whether the web service is being under pen testing or etc.
	5.1 go to triggers
		• Item : zabbix HTTP Nginx (or whather it is selected that receives status of web server)
		• Last of (T): based on 1min Time
		• V (value): 404
		• Result: >= 10
		• OK event generation: None (in order to not be closed if status is changed on next logs)
		• allow manual close.



### 28 - Dependent Items ###
Creating dependent items means that the agent doesn't need to run possibly identical queries on a host many times in order to extract parts of a value. The master item runs once on the host, and then the Zabbix server/proxy updates the dependent items each time the master item is updated.

dependent Items can be used for situation in which there is a Item that consist of lost of information and Regex riched or the resource for data processing of it is on high demand.

to do so, similar to creating an access.log for nginx we can make it as a master item and assing dependent Items to it:
Master:
	name: HTTP Access Log
	Type: zabbix Agent (active)
	Key: log[var/log/nginx/access.log,"^.*",,,skip,,,,]
	type of Information: Log
Dependent Item:
	• Name: HTTP Web Server Status
	• Type: Dependent Item
	• Key: HTTPStatusCode
	• Type: Numeric
	• Master Item: HTTP Access Log
		Preprocessing:
			Regular Expression: ^(\S+) (\S+) (\S+) \[([\w:\/]+\s[+\-]\d{4})\] \"(\S+)\s?(\S+)?\s?(\S+)?\" (\d{3}|-) (\d+|-)\s?\"?([^\"]*)\"?\s?\"?([^\"]*)\"    output: \8	

it is also recommended to create a separate dashboard for dependent Items:
	• create a dashboard with the name and add dependent Items to that.
	note: the created dashboard can be access from; Hosts > Dashboards > (select name of the dashboard from top bar).

actually by creating a dependent Items connected to master Item with a dashboard for instance the HTTP status, we can see at which time line the status code is changed and if so for example which path where selected.


### 29 - Execute Bat File on Remote Windows Host with Zabbix Agent ###
we can run a bat file (BATch file) which is an executable file for windows from zabbix server.
to do that we can use either zabbix agent active or agent passive. however, which agent passive we can test the outcome because the trigger is send from zabbix-server/proxy.

for that we need to first create or send a bat file to our end-host windows client.
for instance;

example.bat:
@echo off
set d=%date%_%time%
set d=%d:.=%
set d=%d::=%
set d=%d:/=%
COPY c:\temp\abc.txt c:\temp\abc_%d%.txt >nul && (echo 1) || (echo 0)
: this file creates a backup file and name it with the date time it is taken.

in zabbix server:
1.add new Item in your template
2. assign properties:
Name		Backup Example
Type	Zabbix 	agent (active)
Key			system.run[C:/temp/example.bat]

for mode: no wait means that the outcome is not important for zabbix. but wait means the outcome needs to be shown in zabbix-server. defaut is wait.

https://www.zabbix.com/documentation/current/en/manual/config/items/itemtypes/zabbix_agent#system.run

note:
the system.run is disabled by default due to security but it can be enabled in agent file of end-host:
AllowKey=<pattern> - which checks are allowed; <pattern> is specified using a wildcard (*) expression
DenyKey=<pattern> - which checks are denied; <pattern> is specified using a wildcard (*) expression
for instance: 
AllowKey=[system.run[C:/temp/example.bat]

patterns can consist of specific rules, directories, permission or locations.
for further patterns check the link below:
https://www.zabbix.com/documentation/current/en/manual/config/items/restrict_checks

note: after changes restart the agent.

note that it is recommended for items to come with trigger.



### 30 - Execute a Shell Script using Zabbix Agent ###


*** CREATE A PLOT TO USE WHAT YOU HAVE LEANED ***

in linux system bash script is used for exection of command or programs.
it is similar to windows bat file.

in linux end-host:
1.first create a directory for zabbix:
	mkdir /home/zabbix/
2. add the script bash file:
	nano ./checkssl.sh:
```````````````````````````````````````````
data=`echo | openssl s_client -servername $1 -connect $1:${2:-443} 2>/dev/null | openssl x509 -in /dev/stdin -noout -enddate | sed -e 's#notAfter=##'`

ssldate=`date -d "${data}" '+%s'`

nowdate=`date '+%s'`

diff="$((${ssldate}-${nowdate}))"

echo $((${diff}/86400))
``````````````````````````````````````````
note:
the script actually checks the certification expiration date and send it back to terminal.
it also have optional port number which can be given.
if certbot is used the expiration will be automatically regenerated.

3. give permission of execution to it: chmod a+x checkssl.sh
sudo -H -u zabbix bash -c 'heckssl.sh google.com' => you can check if permission is allowed.

4. create an Item for it with properties of:
- Name: SSL Certification Check with option google.com
- Type: Zabbix agent
- Key: system.run[/home/zabbix/checkssl.sh google.com]
- Type of information: Numeric (float)



### 31 - User Defined Parameters ###
user defined parameters is similar to system.run command but its difference is that it deosn't need permission to be assigned because the commands and parameters are given by the user itself. also that parameter will be used in zabbix-server items parameters.

for example:
1. first create a parameter in end-host
in /etc/zabbix/zabbix_agentd.conf add:
• UserParameter=isalive,echo 1 => this command will create a parameter name "isalive" and it echos 1 in terminal.

we can test it by:
• zabbix_agentd -t isalive => it test that parameters.

2. then restart zabbix agent
in the zabbix-server add new host item.
- name: is alive
- agent active/passive (with passive we can check it on server.)
- key: isalive ( what that is created in UserParameter
- Type of information (numeric unasigned)


Flexible User Parameters
we can also create parameters that accept dynamic inputs. for example we can used them instead of system.run.

1. add userparameter to the zabbix agent configuration file.
• UserParameter=checkssl[*],/home/zabbix/checkssl.sh $1 $2 => this line create a parameter name "checkssl" and accepts any input, then it will run /home/zabbix/checkssl.sh with 2 parameters that it will receive.

	1.2 you can check it by:
	• zabbix_agent -t checkssl[example.com, 443 (443 is optional)].
		1.3 restart agent service.

2. create new Item in zabbix server.
-Name:				checkssl (domain you want)
-Key:				checkssl[example.com,443]
-Type of information:	Numeric (unsigned)



### 32 - Calculated Items ###
a calculated item allows to create a calculation based on the values of some existing item and it is similar to dependent items. for example want to calculate the hourly average of some item value or to calculate the total value for a group of items.
the difference between calculated and dependent is that the calculated is used to store data and conduct a process on them.

example:
going to receive the query counts of mysql and then calculate on them based on how much volatation it got over time. for example number of queries over time.
* it helps us to see if our data base is busy or not.

1. add the new userParameter to agent configuration:
• UserParameter=mysql.queries, mysqladmin status | cut -f4 -d":" | cut -f1 -d"S"
	- test it by:  zabbix_agent -t mysql.queries
2. add a new mysql config file to /var/lib/ in order to allow zabbix user to use mysqladmin privileges
	• mkdir /var/lib/zabbix
		• nano .my.cnf
			• add these lines to it which are user/password of zabbix in mysql
				[client]
				user='zabbix'
				password='password'
3. restart the agent and test it by:
	• sudo -H -u zabbix bash -c 'zabbix_agentd -t mysql.queries'

4. add new item for mysql.queries
-Name:		MySQL queries Running Total
-Type:		Zabbix Agent
-Key:		mysql.queries ( what that is added on userparameter)
-Type:		numeric

5. add a calculate Item that shows fluctuation of changes over time.
-Name:		fluctuation of MySql queries
-Type:		Calculated
-Key:		mysqlChanges
-Formula:	change(/Zabbix server/mysql.queries)

6. add another item that shows the average change.
-Name:		Average Changes of MySql queries
-Type:		Calculated
-Key:		avgMysqlChanges
-Formula:	avg(/Zabbix server/mysqlChanges,#5)

7. create a graph and add them all to that graph

8. add a forcast item that will predict the next value for the database queries.
-Name:		Forecast of Changes of MySql Questions
-Type:		Calculated
-Key:		forcastMysqlChanges
-Formula:	forecast(/Zabbix server/mysqlChanges,1h,10m,"exponential")


https://www.zabbix.com/documentation/current/en/manual/config/items/itemtypes/calculated

https://www.zabbix.com/documentation/current/en/manual/appendix/functions

https://www.zabbix.com/documentation/current/en/manual/appendix/functions/aggregate



### 33 - Global Scripts ###
global script in older zabbix version was in Administrator tabs and was called a Administration Script.
global script is used to execute command on behalf of zabbix server.
this commands can be as simple as pinging an end-host or execute a compicated command.
some predefined scripts are located in:
alerts > scripts > (ping, Traceroute, Detect Operating system.

note:
before using the global script it should be first activated on zabbix server/proxy in the cofiguration file:
/etc/zabbix/zabbix_server.conf:
• EnableGlobalScripts=1 => enabling the global script 
# note
in order of using Zabbix agent/proxy:
remember to enable "EnableRemoteCommands" on zabbix_proxy.conf file.

• restart the zabbix-server service

for some commands such as ping or traceroute or OS detection, the firewall between server/proxy and the end host does effect the result.


Detecting OS
zabbix uses nmap to detect end host Operating System, and nmap does that by scanning specific ports in order to figure out the Operating system. so two things are important here.
1. the nmap command should be added to permitted in order to be executed by zabbix server.
• in visudo:
	• zabbix ALL=(ALL) NOPASSWD: /usr/bin/nmap => this line into privileges will allow zabbix to run the nmap without password.

in previous versions of Zabbix, some commands such as "free" or etc should be also added to allowkey/denykey of zabbix_agent. also zabbix agent can execute command on be half of zabbix server for instance:

Stopping Starting Windows Services
on alert > script > create new script:
-Name: 					Windows/Restart Print Spooler
-Type: 					script
-Execute on:				Zabbix agent
-commands:				powershell -NoProfile -ExecutionPolicy bypass Restart-Service -Name 'Spooler'
-user group: 				zabbix administrator
-Host group:				Windows server (your choice)
-Required host permission: Read

to get status of service:
• powershell -NoProfile -ExecutionPolicy bypass Get-Service -Name 'Spooler'

note that you cannot restart zabbix agent service, cause it will be stop and won't be started again. unless you have a another service that has privilege to restart zabbix agent and send the restart command to that.

https://www.zabbix.com/documentation/7.0/en/manual/web_interface/frontend_sections/alerts/scripts?hl=Scripts%2Cglobal%2Cscripts%2CGlobal



### 35 - Install and Configure Zabbix Proxy ###

for zabbix proxy installation on server follow the zabbix manual:
https://www.zabbix.com/download?zabbix=7.0&os_distribution=ubuntu&os_version=22.04&components=proxy&db=mysql&ws=

zabbix server configuration:
• zabbix proxy active/passvie mode:
ProxyMode:
passive mode (1): it means that the proxy will only process when a new role or command is send to it.
active mode (0): (recommeded), the proxy server will always try to keep in sync itself with server.

• server= (ip address) the ip address of the zabbix server(s) that zabbix proxy is going to communicate. ( if the proxy is an active proxy otherwise the activeServer should be set)

• hostname = (proxy hostname) it should be match with the one that is going to be defined in zabbix server.

• port = the proxy default listening port is 10051 but it can be changed.

• DBName= the database name that it is going to be connected to proxy.
( it is recommended to add proxy database into /tmp/zabbix_proxy.db directory for security and performance reasons.

# note:
Proxy usecase is broad, for example you can use a small raspberry PI proxy for your CGNAT (Carrier-Grade Network Address Translation) which is when the end-host are located in remote and the IPs are dynamic and not static.



### 36 - Configure Zabbix Agent on the zabbix Proxy ###
installing zabbix agent on zabbix proxy is useful to send back data that is related to zabbix proxy itself, such as database integration or zabbix_proxy health.

to do so first,
1. we need to install zabbix agent on zabbix proxy server.
2. configure agent server address (if passive) / serverActive (if Active) and host name

note: zabbix agent and zabbix proxy on same machine actually don't really know about actual state of each other they will treat each other as different hosts
the proxy will do passive checks on agent and agent will do active checks to send information to zabbix proxy.

3. add a new host in zabbix server, and the information that is going to be given is from the perspective of zabbix proxy:
- hostname: (host name defined in agent)
- template: (linux zabbix agent)
- interface: address:127.0.0.1 Port: 10050 (this is the ip from the perspective of proxy)

4. for zabbix to look for client in its localhost we also need to do a hard reload cache.
	4.2: for speeding up the process we use:
	• sudo zabbix proxy -R config_cache_reload => it hard reloads the proxy instead of restarting service.
	4.3: we can also config "ConfigFrequency" in order to change time that the proxy server requests for new configuration from zabbix server.

( this updating cache dilemma is fixed in latest zabbix updates)


### 37 - Reconfigure Zabbix Agents to use Zabbix Proxy ###

in adding hosts to proxy server two methods should be considered.
first, if the proxy is in active check, in adding a new host, in the host attributes, the interface should also be added. (the interface from perspective of active proxy).

if the proxy is in passive mode and the agent running on end-host is active, the proxy IP address should be configured on the end-host device and no interface is needed in adding the item in zabbix server. (however, for both scenarios the proxy IP should be informed to agents.

note:
in windows end hosts when the proxy is going to be added to zabbix_agent.conf file, the name of proxy can be used instead of IP address of the proxy.

note:
if a client is using agent active on proxy active server the client won't have the availability key on it.



### 38 - Install Zabbix Agent on MacOS Behind the Proxy ###
the installation of zabbix agent on MacOS is a little bit different but similar to linux.
it is also important to note that zabbix agent on macOS is only on passive mode. so no activeServer needs to be configured.


https://sbcode.net/zabbix/agent-osx-firewall/

https://www.zabbix.com/documentation/7.2/en/manual/concepts/agent2



### 39 - Zabbix Server Health ###

we can monitor the processes and server health over of zabbix
in Dashboard > All dashboards > zabbix server health

1. Value processes per second:
shows how zabbix server is busy at the current moment and it consist of different kind of processes running on zabbix.


2. utilization of data collectors
shows different items that is being monitor and information about which protocol their are using to send data or if they are in passive or active mode and etc.

in default it should not be really high. but if there is a problem, the value with increase and it will be a demonstration that some for example a trigger is used that is hard to process or host is having a problem.


3. utilization of internal process
they are lots of thing happening behind in zabbix for example discovery rules, alerting, working out if host is available, house keeping. all these processes can be monitor from here and similar to data collectors utilization the processes should be on low percentage unless there is a problem.


4. cache usage
cache is used in zabbix in order to improve performance and speed, it demonstrate the data that is cached in memory. the more it takes from cache the faster it gets but be aware to not overload the memory usage.
cache usage is fine until it rise over 80% and configuration is the most that uses the caches.

note:
cache size can be changed in zabbix configuration and the parameter is " CacheSize " and its default value is 8Mb but it should be changed as more hosts will be added to zabbix.


7. Value cache effectiveness
it demonstrates two values, 1. the value cache hits, 2. the value cache misses.
the value cache hit means that the data is accessible from memory cache and the miss means that the data needs to be retrieved from the storage or database.
the hit value should always be high and miss value should be as low as possible, otherwise there is problem in caching.


8. Queue size:
 a queue and the request/response is handled as soon as possible. Some requests on hosts don't resolve quickly due to many reasons, such as the host may be switched off, or may be experiencing other resource issues such as high CPU, low memory, low network bandwidth or just in the process of restarting.

To see a list of items in the queue, and which host they relate to, visit the page Administration ⇾ Queue ⇾ Queue details.

some queues may stuck in long term no response error such as discovery rules for network interface.
for that we can disable them on each host. but it should be reviewed and documented.

note:
"unlink and clear" on template field for each host means to clear the data that is being collected.

another way to check out zabbix server health from hosts:
Monitoring ⇾ hosts ⇾ (select dashboard of a host ) ⇾ on top bar select "zabbix server health".



### 40 - Zabbix Proxy Health ###

with use of zabbix agent on zabbix proxy server we can also collect information related to zabbix proxy server.
for that we need to change some configuration.

in the hosts, select the host that is responsible/charge	of collecting data from zabbix proxy, and add new template called " zabbix proxy health ". it may become two templates which is fine.
then in Monitoring ⇾ hosts ⇾ (host related to collect info from proxy) ⇾ dashboard:
you will see an extra dashboard with the name " zabbix proxy health ".



### 41 - Enable PSK Encryption for Zabbix Proxy ###

if any encryption is done between the agent and the zabbix server before that, that encryption would only be applied between agent and proxy (if it is). because the zabbix proxy copies a copy from all the secrets that exists in zabbix server to itself in order to communicate with other hosts. but it doesn't have an encrypted between proxy and server. thus the secret of agents can be also visible due to lack of encryption between them.

steps:
1. create a directory in proxy for zabbix 
• mkdir /home/zabbix

2. add a secret.psk file to it with the secret number
• openssl rand -hex 32 => generate a zabbix proxy
• nano/vim secret.psk => create a secret.psk file inside that directory and add the secret number.

• change permission of secret.psk file:
	• chown zabbix:zabbix secret.psk
	• chmod 640 secret.psk

3. add secret to proxy config file.
• etc/zabbix/zabbix_proxy.conf
	• TLSConnect = psk
	• TLSAccept = psk (not mandatory) if zabbix server is the intiator and not the proxy it will be mandatory.
	• TLSPSKIdentity= (name to be identified for psk exchange)
	• TLSPSKFile = /home/zabbix/secret.psk (the file that is created)

save and restart the proxy.

4. in zabbix server > proxies > (select the proxy in used) > encryption > select PSK.
	• add identity ( which is defined in proxy server)
	• PSK : just add another random number that is created by openssl command.

note:
with PSK enabled the zabbix server will no longer treat multiple proxies with same names because each will use a different PSK and identifier.



### 42 - Item Cloning to Create a PCI DSS Windows Template ###
https://sbcode.net/zabbix/item-cloning-pci-dss/
use cloning option to make a template dedicated to only monitor Event Logs of windows clients.

to do so we can create a failed log on ( from session 22) and also a trigger for that and then make clones to monitor other EventIDs.
the important Events are:

EventID 4608 : Windows is starting up
EventID 4609 : Windows is shutting down
EventID 4610 : An authentication package has been loaded by the Local Security Authority
EventID 4611 : A trusted logon process has been registered with the Local Security Authority
EventID 4612 : Internal resources allocated for the queuing of audit messages have been exhausted, leading to the loss of some audits
EventID 4614 : A notification package has been loaded by the Security Account Manager
EventID 4616 : The system time was changed
EventID 4624 : Successful Logon
EventID 4625 : Failed Logon
EventID 4634 : An account was logged off
EventID 4657 : A registry value was modified
EventID 4660 : An object was deleted
EventID 4663 : An attempt was made to access an object
EventID 4670 : Permissions on an object were changed
EventID 4674 : An operation was attempted on a privileged object
EventID 4720 : A user account was created
EventID 4722 : A user account was enabled
EventID 4723 : An attempt was made to change an account's password
EventID 4725 : A user account was disabled
EventID 4726 : A user account was deleted
EventID 4727 : A security-enabled global group was created
EventID 4728 : A member was added to a security-enabled global group
EventID 4729 : A member was removed from a security-enabled global group
EventID 4730 : A security-enabled global group was deleted
EventID 4731 : A security-enabled local group was created
EventID 4732 : A member was added to a security-enabled local group
EventID 4733 : A member was removed from a security-enabled local group
EventID 4734 : A security-enabled local group was deleted
EventID 4738 : A user account was changed
EventID 4740 : A user account was locked out
EventID 4767 : A user account was unlocked
EventID 5143 : A network share object was modified
EventID 6144 : Security policy in the group policy objects has been applied successfully

it is also possible to make a master Item that logs all data from the Event Viewer like this:

eventlog[Security,,,,4608|4609|4610|4611|4612|4614|4616|4624|4625|4634|4657|4660|4663|4670|4674|4720|4722|4723|4725|4726|4727|4728|4729|4730|4731|4732|4733|4734|4738|4740|4767|5143|6144,,skip]



### 43 - Importing Templates ###
we can do import or export templates in 3 format file:
1. YAML
2. XML
3. JSON
all these files are open sourced and each can be edited.
Templates > (select a Template ) > on down bar select Export.
Template > from top bar select Import.
note that in importing templates, we can modify whether a items or other component should be added or not or if there is a missing value how should it be treated.



### 44 - Slack Media Type ###
slack is a powerful tool for receiving alert or messages, thus slack can be used for receiving data information from zabbix.
Media Type is zabbix consist of many applications and protocols in order to be used to send and receive notification from zabbix server.

first of all a slack account needs to be stablished with a channel, then the slack Bot token and channel can be added to Zabbix media to send notification with it.
Alert > Media Type > Slack

follow tutorial video if you want to add slack to media
or 
https://sbcode.net/zabbix/media-types-slack/



### 45 - Telegram Media Type ###
similar to slack, telegram can be used to receive notification from zabbix server.
to do that first we need to create a bot in botfather and then give it proper name and user authority.
steps are:
1. in @BotFather, use Menu bar and select /newbot
2. choose a name for it
3. create a username for bot and follow instruction.
3. then copy the HTTP API token and in > Alert > Media > Telegram > Token Field.

then u need to add the bot into a group or channel to let it send notification to that. to do so.
1. you need to be able to see the API logs and information being passed by Token so use this like in your web browser to see all information the bot is intracting:
https://api.telegram.org/botXXX:YYY/getUpdates (replace the XXX: YYY with your HTTP API Token you just got from Telegram)
for example:
https://api.telegram.org/bot764543238:AAHA5324y45dfgsdkLo/getUpdates
2. add your bot in a group or channel and then use the link about to extract the ID number of the group/channel that you want the bot to send data (it usually is a ID number with negative sign).
exameple:
-5234111
3. then add that number to the {Alert SENDTO} field in Zabbix server.

+ https://core.telegram.org/bots/api#getting-updates
+ https://www.zabbix.com/documentation/current/en/manual/appendix/macros/supported_by_location

### 46 - Customising Trigger Alert Messages with Macros ###
Macros are used in various situations, these macros are variables, identified by a specific syntax.
for example:
{ALERT.MESSAGE} => which is a macro and inside that message any message can be defined.

macros with " $ " sign are user defined macros.
macros with " # " sign means that are added by Discovery rules

there is not a single centralized location to see all macros because each host and template can have its own macros so to see macros:
• Data collection > Hosts > (select the host) > on top bar select Macros > (list of all macros from inherited and host based).
• Administration > Macros
• Templates > (select a template) > Macros 

for test
create a trigger with macro name instead of static values for Windows Clients
-Trigger-
• Name: Disk Space Above 2GB - the current is: {ITEM.VALUE}
Expression:
	• Item: FS [(C:)]: Space: Used
	• function: last() - Last (most recent) T value
	• result > 2G

this trigger will show warning related to used disk and the amount of occupied disk space
monitor it in:
Monitoring > Problems.



### 47 - Add Disk Space History Graph To OS Linux Template ###
this part is an introduction to LLD (Low Level Discovery) rules and how we can monitor data on a graph.

in more advanced depth, discovery rules are used to find end-host detailed information. by specifying process to them, when a new device is discovered these LLDs look for matching data inside those end-host and when they find them they create graph, item, trigger, etc based on what has been modified.
thus, there is no need to create each item,trigger or graph separately
to see dicovery rules
• Templates > ( on template Names ) > discovery
or
• host > discovery

note:
after each change on discovery rule components, pay attention that update interval can be vary.

(Item prototypes)

(discovery rules filter )



### 48 - Trigger Prototypes and Triggering within a Range ###
by using discovery rules (LLD - Low Level Discovery) we can set trigger and item prototypes for each host that is going to use that discovery and also with a specific trigger to that.
for going to that configuration there are several ways. for example chaing it throw  Template:
• Data collection > Templates > ( a Template ) > Discovery > Item Prototypes & Trigger Prototypes.
or from Hosts:
• Hosts > Discovery > Item prototypes & Trigger Prototypes.

remember if the discovery rules are being send to host agents through Proxy server, the proxy server configuration cache should be restarted in order to receive new configuration sooner.
• sudo zabbix proxy -R config_cache_reload 

note:
in adding Prototype Trigger, if the Item that is going to have a trigger is an Item Prototype then in "Create Trigger" the Item should be selected from Item Prototypes.

we can create a multipe expression triggers for example between 10% and 20% which multiple expressions will be added to trigger but there should not be a conflict.




### 49 - Configure Trigger 'Ok Event Generation' to Minimize Alert Flapping ###
Triggers that alert problems and the resolutions too frequently can cause a symptom commonly referred to as Alert Flapping. we can edit Ok Event Generation properies of a trigger to either delay the OK (resolved) event for a period of time, or try disabling it and adding the option to manually close the problem.

important to not make tolerance too sensitive. for instance writing conditional expression for trigger with OK event generation expressions. or increase/decrease recovery expression time stamp.
note that not "everything" is required to be notified. 
Template > Triggers > 
• Problem expression.
• Recovery expression
Trigger prototype properties:



### 50 - Execute Python Script on Remote Linux Host with Zabbix Agent ###
why do we need to execute python, bat or bash file on the end host client?
they are several reasons that we may want to do such an action, for example to troubleshoot a problem or to increase capability and potentiality of the zabbix for instance writing a script that will collect data from a service and send tha to zabbix server in customized way.

note:
on some OS the python3 is installed so for example the command "python -v" won't work and instead "python3 -v" can show you version of python.

to do so, same as bash or bat file;
1. create a directory file for zabbix and add the script file to it.
• mkdir /home/zabbix/
• vim script.py
2. add script to the script.py file:
"
import random
print(random.randint(0,36))
" => this script creates random number and shows it

save and test: 
python3 script.py

3. remember that this command should also be added to AllowKey
sudo vim /etc/zabbix/zabbix_agentd.conf
	• AllowKey=system.run[python3 /home/zabbix/script.py]
3.2 restart agent:
	systemctl restart zabbix-agent

4. add the item to zabbix server UI

Name				Generate Random Number - Python script
Type					Zabbix agent
Key					system.run[python3 /home/zabbix/script.py]
Type of information	Numeric (Or Text if you want to see the error message in the latest data)



### 51 - Execute Powershell Scripts to Check Windows Updates ###